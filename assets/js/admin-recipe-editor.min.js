var RCPM_Recipe_Editor;!function(e,t){"use strict";var i=t||{ingredients:{},measurement_units:{singular:{},plural:{}},I10n:{phase:"Phase",confirm_delete_phase:"Are you sure you want to delete this phase?"}},n=i.I10n,a=i.ingredients,r={singular:[],plural:[]};e.each(i.measurement_units.singular,function(e,t){r.singular.push({key:e,value:t,label:t})}),e.each(i.measurement_units.plural,function(e,t){r.plural.push({key:e,value:t,label:t})}),Number.prototype.pad=function(e){for(var t=String(this);t.length<(e||2);)t="0"+t;return t},String.prototype.toDecimal=function(){var e=String(this);if(e.indexOf("/")!=-1){var t,i=e.split(" ");return i.length>1?t=i[1].split("/"):(t=i[0].split("/"),i[0]=0),parseInt(i[0],10)+parseInt(t[0],10)/parseInt(t[1],10)}return e},RCPM_Recipe_Editor={close_phase:function(){e(".phases .phase").removeClass("active"),e(".phases .phase-content").slideUp(300).removeClass("open")},renumber_ingredients:function(t){t.find(".recipe-ingredients tbody tr").each(function(){var t=e(this),i=t.parent().children().index(t);t.data("ingredientindex");t.data("ingredientindex",i),t.find("input, textarea, select").each(function(){this.name=this.name.replace(/\[ingredients]\[([0-9])*]/,"[ingredients]["+i+"]")})})},renumber_steps:function(t){t.find(".recipe-steps tbody tr").each(function(){var t=e(this),i=t.parent().children().index(t);t.data("stepindex");t.data("stepindex",i),t.find("input, textarea, select").each(function(){this.name=this.name.replace(/\[steps]\[([0-9])*]/,"[steps]["+i+"]")})})},renumber_ingredients_steps:function(e){RCPM_Recipe_Editor.renumber_ingredients(e),RCPM_Recipe_Editor.renumber_steps(e)},renumber_phases:function(){e(".phases .phase").each(function(){var t=e(this),i=t.parent().children().index(t),n=i+1;t.data("phaseindex");t.data("phaseindex",i),t.find(".phase-title").data("target","#phase-"+n),t.find(".phase-content").attr("id","phase-"+n),t.find(".recipe-ingredients, .recipe-steps").find("input, textarea, select").each(function(){this.name=this.name.replace(/recipe_card\[([0-9])*]/,"recipe_card["+i+"]")}),RCPM_Recipe_Editor.renumber_ingredients_steps(t),RCPM_Recipe_Editor.update_phase_title(t)})},update_phase_title:function(e){var t=e.find(".phase-name"),i=e.data("phaseindex")+1,a=n.phase+" "+i;""!==t.val()&&(a=a+": "+t.val()),e.find(".phase-title .title").text(a)},initialize_sortable_tables:function(){e("table.sortable tbody").filter(":not(.ui-sortable)").sortable({handle:".sort-handle .dashicons-menu",placeholder:"ui-state-highlight",forcePlaceholderSize:!0,forceHelperSize:!0,start:function(e,t){t.placeholder.height(t.item.outerHeight())},helper:function(t,i){var n=i.children(),a=i.clone();return a.children().each(function(t){e(this).width(n.eq(t).outerWidth)}),a},stop:function(){RCPM_Recipe_Editor.renumber_phases()}})},initialize_ingredient_autocomplete:function(){e(".ingredient-unit-autocomplete").filter(":not(.ui-autocomplete-input)").autocomplete({source:r.singular,autoFocus:!0,select:function(t,i){e(t.target).parent().find(".ingredient-unit").val(i.item.key)},change:function(t,i){var n,a=e(t.target),s=a.parents("tr").find(".ingredient-measure").val().toDecimal(),o=s<=1||""===s?r.singular:r.plural;i.item?n=i.item.key:(n=e.grep(o,function(e){return e.value.toLowerCase()===a.val().toLowerCase()}),n=n.length?n[0].key:""),a.parent().find(".ingredient-unit").val(n)}}).on("blur",function(){e(this).trigger("autocompleteselect").trigger("autocompletechange")}),e(".ingredient-label").filter(":not(.ui-autocomplete-input)").autocomplete({minLength:2,source:a,autoFocus:!0,select:function(t,i){e(t.target).parent().find(".ingredient-id").val(i.item.ID)},change:function(t,i){var n,r=e(t.target);i.item?n=i.item.ID:(n=e.grep(a,function(e){return e.value===r.val()}),n=n.length?n[0].ID:0),r.parent().find(".ingredient-id").val(n)}}).on("blur",function(){e(this).trigger("autocompleteselect").trigger("autocompletechange")})},update_ingredient_measure_pluralily:function(e){var t=e.parents("tr").find(".ingredient-unit-autocomplete"),n=e.parents("tr").find(".ingredient-unit"),a=e.val().toDecimal();a>1?(t.autocomplete("option","source",r.plural),t.val(i.measurement_units.plural[n.val()])):(t.autocomplete("option","source",r.singular),t.val(i.measurement_units.singular[n.val()]))},convert_hhmm_to_seconds:function(e){var t,i,n;return"string"==typeof e?Number(e)==e?Number(e):(t=e.split(":"),i=t[0],n=t[1],3600*i+60*n):e},convert_seconds_to_hhmm:function(e){var t=Number(e),i=parseInt(t/60)%60,n=parseInt(t/3600)%24;return n.pad()+":"+i.pad()},update_total_time:function(){var t=RCPM_Recipe_Editor.convert_hhmm_to_seconds(e("#prep_time").val()),i=RCPM_Recipe_Editor.convert_hhmm_to_seconds(e("#cook_time").val()),n=t+i;e("#total_time").val(RCPM_Recipe_Editor.convert_seconds_to_hhmm(n))}},e(document).on("click",".phase-title",function(t){var i=e(this),n=i.data("target"),a=i.parent();a.is(".active")?RCPM_Recipe_Editor.close_phase():(RCPM_Recipe_Editor.close_phase(),a.addClass("active"),e(".phases "+n).slideDown(300,function(){e("html, body").animate({scrollTop:i.offset().top-100},300)}).addClass("open")),t.preventDefault(),t.stopPropagation()}).on("click",".add-phase",function(t){var i=_.template(e("script#recipe-card-phase-templ").html()),n=e(".phases .phase").length,a={phaseIndex:n,phaseNumber:n+1};e(".phases .phase:last").after(i(a)),e(".phases .phase:last .phase-title").trigger("click"),e(".phases .phase:last .phase-name").trigger("focus"),RCPM_Recipe_Editor.renumber_phases(),RCPM_Recipe_Editor.initialize_sortable_tables(),RCPM_Recipe_Editor.initialize_ingredient_autocomplete(),t.preventDefault(),t.stopPropagation()}).on("click",".remove-phase",function(t){window.confirm(n.confirm_delete_phase)&&e(this).parents(".phase:first").slideUp(300,function(){e(this).remove()}),t.preventDefault(),t.stopPropagation()}).on("click",".add-ingredient, .add-step",function(t){var i,n=e(this),a=n.parents(".phase"),r={phaseIndex:a.data("phaseIndex")};n.hasClass("add-step")?i=_.template(e("script#recipe-card-step-templ").html()):n.hasClass("add-ingredient")&&(i=_.template(e("script#recipe-card-ingredient-templ").html())),n.parents("tr:first").after(i(r)),n.parents("tr:first").next().find("input, select, textarea").eq(0).trigger("focus"),RCPM_Recipe_Editor.initialize_ingredient_autocomplete(),RCPM_Recipe_Editor.renumber_phases(),t.preventDefault(),t.stopPropagation()}).on("click",".remove-ingredient, .remove-step",function(t){var i=e(this);i.parents("tr:first").remove(),RCPM_Recipe_Editor.renumber_phases(),t.preventDefault(),t.stopPropagation()}).on("input",".phase-name",function(){RCPM_Recipe_Editor.update_phase_title(e(this).parents(".phase"))}).on("keypress",".phase table input,.phase table select,.phase table textarea",function(t){13!==t.keyCode&&10!==t.keyCode||(t.ctrlKey&&e(t.target).parents("tr:first").find(".add-ingredient, .add-step").eq(0).trigger("click"),e(t.target).is("textarea")||t.preventDefault())}).on("keyup",".phase textarea",function(){for(var t=e(this);t.outerHeight()<this.scrollHeight+parseFloat(t.css("borderTopWidth"))+parseFloat(t.css("borderBottomWidth"));)t.height(t.height()+1)}).on("blur",".ingredient-measure",function(){RCPM_Recipe_Editor.update_ingredient_measure_pluralily(e(this))}).on("blur","#prep_time, #cook_time",function(t){"total_time"!==e(t.target).attr("id")&&RCPM_Recipe_Editor.update_total_time()}).ready(function(){e(".phases .phase:first").addClass("active").find(".phase-content").addClass("open").slideDown(0),RCPM_Recipe_Editor.renumber_phases(),RCPM_Recipe_Editor.initialize_sortable_tables(),RCPM_Recipe_Editor.initialize_ingredient_autocomplete(),e(".phases").sortable({handle:".phase-title .dashicons-menu",placeholder:"ui-state-highlight",forcePlaceholderSize:!0,start:function(e,t){t.placeholder.height(t.item.outerHeight())},stop:function(){RCPM_Recipe_Editor.renumber_phases()}}),e(".phase textarea").each(function(){for(var t=e(this);t.outerHeight()<this.scrollHeight+parseFloat(t.css("borderTopWidth"))+parseFloat(t.css("borderBottomWidth"));)t.height(t.height()+1)}),e.widget("ui.timespinner",e.ui.spinner,{options:{step:60,page:60,min:0,max:86400},_parse:function(e){return RCPM_Recipe_Editor.convert_hhmm_to_seconds(e)},_format:function(e){return RCPM_Recipe_Editor.convert_seconds_to_hhmm(e)}}),e(".timespinner").timespinner({stop:function(t){"total_time"!==e(t.target).attr("id")&&RCPM_Recipe_Editor.update_total_time()},spin:function(t){"total_time"!==e(t.target).attr("id")&&RCPM_Recipe_Editor.update_total_time()}})})}(jQuery,rcpm_recipe_editor_vars);